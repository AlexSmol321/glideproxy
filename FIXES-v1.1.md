# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ universal-proxy-installer-v1.4-as.sh
1. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–¶–µ–ª—å	–ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
–°–ª–æ–π HTTPS-—Ç–µ—Ä–º–∏–Ω–∞—Ü–∏–∏	Nginx + Let‚Äôs Encrypt, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
–ü—Ä–æ–∑—Ä–∞—á–Ω–æ–µ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ Glide-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è	http-proxy-middleware c –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
–ó–∞–ø—Ä–µ—Ç –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è –≤ <iframe>	X-Frame-Options: DENY –≤—ã–¥–∞—ë—Ç—Å—è –Ω–∞ –≤—Å–µ –æ—Ç–≤–µ—Ç—ã
CSP, —Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è —Å Glide	default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;
–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞	–û–¥–∏–Ω app.js, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Äî PM2, –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫, cron-restart –≤ 03:00

2. –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
/opt/my-proxy/
‚îú‚îÄ‚îÄ src/app.js            # –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Node.js
‚îú‚îÄ‚îÄ ecosystem.config.js   # –∫–æ–Ω—Ñ–∏–≥ PM2
‚îú‚îÄ‚îÄ .env                  # –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–¥–æ–º–µ–Ω-—Ü–µ–ª—å, –ø–æ—Ä—Ç—ã‚Ä¶)
‚îú‚îÄ‚îÄ config/nginx-proxy.conf   # –≥–æ—Ç–æ–≤—ã–π virtual-host
‚îú‚îÄ‚îÄ scripts/              # status/restart/logs/renew-ssl
‚îî‚îÄ‚îÄ logs/                 # –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ PM2
3. –ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (.env)
env
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
NODE_ENV=production
PORT=3000

PROXY_DOMAIN=as-csoftware.ru
TARGET_DOMAIN=ascs-projects.glide.page
TARGET_PROTOCOL=https

# –≤–∫–ª—é—á–µ–Ω—ã:
ENHANCED_COMPATIBILITY=true
MINIMAL_MODE=true
–ú–µ–Ω—è—Ç—å –¥–æ–º–µ–Ω—ã/–ø–æ—Ä—Ç ‚Äî —Å—Ç—Ä–æ–≥–æ –∑–¥–µ—Å—å; –ø–æ—Å–ª–µ –ø—Ä–∞–≤–∫–∏ ‚Üí pm2 restart my-proxy --update-env.

4. –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏, –≤—ã—Å—Ç–∞–≤–ª—è–µ–º—ã–µ –ø—Ä–æ–∫—Å–∏
text
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
X-Frame-Options: DENY                              # –∑–∞–ø—Ä–µ—Ç <iframe>
Content-Security-Policy: default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;
Access-Control-Allow-Origin: *                     # CORS (–º–æ–∂–Ω–æ —Å—É–∑–∏—Ç—å)
Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS, PATCH
Access-Control-Allow-Headers: Content-Type, Authorization, X-Requested-With, Accept
Access-Control-Allow-Credentials: true
5. –≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è
–û–ø–µ—Ä–∞—Ü–∏—è	–ö–æ–º–∞–Ω–¥–∞ / —Ñ–∞–π–ª
–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤	/opt/my-proxy/scripts/status.sh
Live-–ª–æ–≥–∏	/opt/my-proxy/scripts/logs.sh –∏–ª–∏ pm2 logs my-proxy
–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è	/opt/my-proxy/scripts/restart.sh
–û–±–Ω–æ–≤–∏—Ç—å SSL –≤—Ä—É—á–Ω—É—é	/opt/my-proxy/scripts/renew-ssl.sh
–°–Ω—è—Ç—å –¥–∞–º–ø –ø—Ä–æ—Ü–µ—Å—Å–æ–≤	pm2 save
–°—Ç–∞—Ä—Ç / —Å—Ç–æ–ø PM2	`pm2 start

6. –¢–æ—á–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª—è
Health-—á–µ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

css
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
curl -s https://as-csoftware.ru/health        # { "status": "ok" }
HTTP‚ÜíHTTPS —Ä–µ–¥–∏—Ä–µ–∫—Ç

perl
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
curl -I http://as-csoftware.ru/ | grep "301"
–ó–∞–≥–æ–ª–æ–≤–æ–∫ CSP

css
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
curl --http1.1 -I https://as-csoftware.ru/ | grep -i content-security-policy
7. –ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É CSP –∏–ª–∏ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –¥–æ–º–µ–Ω—ã
–§–∞–π–ª: /opt/my-proxy/src/app.js, –±–ª–æ–∫ onProxyRes

js
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
// –ø—Ä–∏–º–µ—Ä –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
proxyRes.headers['content-security-policy'] =
  "default-src 'self'; script-src 'self' https://*.glideapps.com 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src * data: blob:;";
–ü–æ—Å–ª–µ –ø—Ä–∞–≤–∫–∏:

bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
pm2 restart my-proxy
pm2 save
8. –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ / –º–∏–≥—Ä–∞—Ü–∏—è
bash
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
tar czf proxy-backup_$(date +%F).tgz /opt/my-proxy /etc/nginx/sites-available/my-proxy /etc/letsencrypt/live/as-csoftware.ru
# –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —á–∏—Å—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ:
tar xf proxy-backup.tgz -C /
pm2 resurrect          # –µ—Å–ª–∏ PM2-dump –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
systemctl reload nginx

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ Universal Proxy Installer v1.1

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã escape —Å–∏–º–≤–æ–ª—ã –≤ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ `\\$` –≤ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–º –æ—à–∏–±–∫–∞–º.

**–†–µ—à–µ–Ω–∏–µ**: 
- –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `create_nginx_config()` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ escape —Å–∏–º–≤–æ–ª–∞–º–∏
- `\\$` –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `\$` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã nginx

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞**: –£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ —Å —Ç–µ–º –∂–µ –∏–º–µ–Ω–µ–º.

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `/opt/$PROJECT_NAME`
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ `AUTO_CONFIRM=yes`

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –ø–æ—Ä—Ç–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞**: –£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª, –∑–∞–Ω—è—Ç –ª–∏ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–æ—Ä—Ç.

**–†–µ—à–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ `netstat` –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –≤–æ–∑–º–æ–∂–Ω–æ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º

### 4. –£–ª—É—á—à–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞**: –°–∫—Ä–∏–ø—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–æ–∫ –∏ –º–æ–≥–ª–∏ –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –ø—Ä–∏ –ø—Ä–µ—Ä–≤–∞–Ω–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–µ.

**–†–µ—à–µ–Ω–∏–µ**:
- –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `create_management_scripts()`
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

### 5. –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏–∏
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ –±—ã–ª–æ –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏.

**–†–µ—à–µ–Ω–∏–µ**:
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å–∏—è –¥–æ 1.1 (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞

## üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```bash
# –ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
return 301 https://\\$server_name\\$request_uri;

# –°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
return 301 https://\$server_name\$request_uri;
```

### –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
if [ -d "$PROJECT_DIR" ]; then
    log_warning "–ü—Ä–æ–µ–∫—Ç $PROJECT_NAME —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    # –ó–∞–ø—Ä–æ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤
if netstat -tlnp 2>/dev/null | grep -q ":$NODE_PORT "; then
    log_warning "–ü–æ—Ä—Ç $NODE_PORT —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è"
    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ...
fi
```

## üìã –†–µ–∑—É–ª—å—Ç–∞—Ç

–≠—Ç–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ—à–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã, –≤–æ–∑–Ω–∏–∫—à–∏–µ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –≤—Ç–æ—Ä–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ `otter-proxy`:

1. ‚úÖ **nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** —Ç–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –±–µ–∑ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
2. ‚úÖ **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–æ–µ–∫—Ç–æ–≤** –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
3. ‚úÖ **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø–æ—Ä—Ç–æ–≤** –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—é—Ç—Å—è –∑–∞—Ä–∞–Ω–µ–µ  
4. ‚úÖ **–°–∫—Ä–∏–ø—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è** —Å–æ–∑–¥–∞—é—Ç—Å—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ
5. ‚úÖ **–í–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å** –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–æ–∫ –Ω–∞ –æ–¥–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ:

```bash
# –ü–µ—Ä–≤—ã–π –ø—Ä–æ–∫—Å–∏
export PROXY_DOMAIN="proxy1.example.com"
export TARGET_DOMAIN="target1.example.com"
export PROJECT_NAME="proxy1"
export NODE_PORT="3000"
sudo ./universal-proxy-installer.sh

# –í—Ç–æ—Ä–æ–π –ø—Ä–æ–∫—Å–∏
export PROXY_DOMAIN="proxy2.example.com"
export TARGET_DOMAIN="target2.example.com"
export PROJECT_NAME="proxy2"
export NODE_PORT="3001"
sudo ./universal-proxy-installer.sh
```

–£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏—Ç –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã. 
